<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViralX Virus Simulation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      overflow: hidden;
      background: #1a1a1a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      margin: 8px 4px;
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    button.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    button.danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    button.tab {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      margin: 4px;
      border-radius: 8px 8px 0 0;
    }
    
    button.tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    button.speed-control {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      font-size: 18px;
      padding: 15px 30px;
      user-select: none;
    }
    
    button.speed-control:active {
      background: linear-gradient(135deg, #ff5252 0%, #dd4a5f 100%);
    }
    
    input[type="range"] {
      cursor: pointer;
      width: 100%;
      height: 8px;
      background: linear-gradient(to right, #667eea, #764ba2);
      border-radius: 5px;
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .control-panel {
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease;
    }
    
    .control-panel.collapsed {
      transform: translateX(calc(100% + 40px));
    }
    
    .slider-label {
      color: white;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }
    
    .slider-value {
      color: #667eea;
      font-weight: 700;
    }
    
    .preset-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .stats-box {
      background: rgba(50, 50, 50, 0.9);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      border-left: 4px solid #667eea;
    }
    
    .tab-content {
      margin-top: 15px;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .alert-banner {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 50, 50, 0.95);
      color: white;
      padding: 15px 30px;
      borderRadius: 10px;
      fontSize: 18px;
      fontWeight: bold;
      boxShadow: 0 4px 20px rgba(255, 0, 0, 0.5);
      zIndex: 1000;
    }
    
    .superspreader-alert {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 165, 0, 0.95);
      color: white;
      padding: 15px 30px;
      borderRadius: 10px;
      fontSize: 18px;
      fontWeight: bold;
      boxShadow: 0 4px 20px rgba(255, 165, 0, 0.5);
      zIndex: 1000;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .toggle-button {
      position: fixed;
      right: 0px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(40, 40, 40, 0.95);
      border: 2px solid rgba(255,255,255,0.3);
      border-right: none;
      color: white;
      width: 36px;
      height: 80px;
      border-radius: 10px 0 0 10px;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: background 0.2s;
    }
    .toggle-button:hover {
      background: rgba(102, 126, 234, 0.9);
      transform: translateY(-50%);
      box-shadow: none;
    }
    
    .welcome-panel {
      max-width: 800px;
      max-height: 70vh;
      overflow-y: auto;
      background: rgba(30, 30, 30, 0.98);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .virus-decoration {
      width: 150px;
      height: 150px;
      opacity: 0.3;
      filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const CONFIG = {
      CANVAS_WIDTH: window.innerWidth,
      CANVAS_HEIGHT: window.innerHeight,
      SIM_AREA_WIDTH: window.innerWidth,
      PERSON_RADIUS: 12,
      PERSON_SPEED: 3.0,
      SPEED_MULTIPLIER: 4,
      
      PRESETS: {
        COVID: { 
          name: 'COVID-19',
          incubation: 5.5, 
          infectionTime: 14, 
          infectionRate: 0.35, 
          infectionDist: 20, 
          survival: 0.982
        },
        TB: { 
          name: 'Tuberculosis',
          incubation: 10, 
          infectionTime: 14, 
          infectionRate: 0.10, 
          infectionDist: 15, 
          survival: 0.85
        },
        RHINO: { 
          name: 'Rhinovirus',
          incubation: 2, 
          infectionTime: 7, 
          infectionRate: 0.30, 
          infectionDist: 25, 
          survival: 0.999
        },
        MEASLES: { 
          name: 'Measles',
          incubation: 10, 
          infectionTime: 8, 
          infectionRate: 0.90, 
          infectionDist: 100, 
          survival: 0.998
        },
        INFLUENZA: { 
          name: 'Influenza',
          incubation: 2, 
          infectionTime: 7, 
          infectionRate: 0.40, 
          infectionDist: 30, 
          survival: 0.998
        },
        EBOLA: { 
          name: 'Ebola',
          incubation: 8, 
          infectionTime: 10, 
          infectionRate: 0.50, 
          infectionDist: 10, 
          survival: 0.50
        }
      }
    };

    class VirusParticle {
      constructor(fromX, fromY, toX, toY) {
        this.x = fromX;
        this.y = fromY;
        this.targetX = toX;
        this.targetY = toY;
        this.progress = 0;
        this.speed = 0.1;
        this.alive = true;
      }
      
      update() {
        this.progress += this.speed;
        if (this.progress >= 1) {
          this.alive = false;
          return;
        }
        this.x = this.x + (this.targetX - this.x) * this.speed;
        this.y = this.y + (this.targetY - this.y) * this.speed;
      }
      
      draw(ctx) {
        const alpha = 1 - this.progress;
        ctx.fillStyle = `rgba(255, 0, 0, ${alpha})`;
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'rgba(255, 0, 0, 0.8)';
        ctx.beginPath();
        ctx.arc(this.x, this.y, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }

    class Person {
      constructor(x, y, state, incubationDays, infectionDays, variant = 'original') {
        this.x = x;
        this.y = y;
        this.radius = CONFIG.PERSON_RADIUS;
        this.baseSpeed = CONFIG.PERSON_SPEED;
        this.speed = this.baseSpeed;
        
        this.angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(this.angle) * this.speed;
        this.vy = Math.sin(this.angle) * this.speed;
        
        this.state = state;
        this.infectTimer = Math.floor(Math.random() * 60);
        
        this.stuckCounter = 0;
        this.lastX = x;
        this.lastY = y;
        
        this.incubationFrames = incubationDays * 60;
        this.activeInfectionFrames = infectionDays * 60;
        this.totalSickFrames = this.incubationFrames + this.activeInfectionFrames;
        this.sickTimer = this.totalSickFrames;
        
        this.variant = variant;
        this.isSuperSpreader = Math.random() < 0.05;
        
        this.immunityTimer = 0;
      }
      
      move(quarantine, infectedPeople, simWidth, simHeight, mobilityLevel) {
        if (this.state === 'dead') return;
        
        // mobilityLevel: 0 = slow, 1 = normal, 2 = fast
        this.speed = this.baseSpeed * mobilityLevel;
        
        // Wall bouncing ‚Äî only thing that changes direction
        if (this.x <= this.radius) {
          this.x = this.radius + 1;
          this.vx = Math.abs(this.vx);
        }
        if (this.x + this.radius >= simWidth) {
          this.x = simWidth - this.radius - 1;
          this.vx = -Math.abs(this.vx);
        }
        if (this.y <= this.radius) {
          this.y = this.radius + 1;
          this.vy = Math.abs(this.vy);
        }
        if (this.y + this.radius >= simHeight) {
          this.y = simHeight - this.radius - 1;
          this.vy = -Math.abs(this.vy);
        }
        
        // Quarantine repulsion
        if (this.state === 'normal' && quarantine > 0) {
          for (const infected of infectedPeople) {
            if (this.isActivelySick(infected)) {
              const dist = this.distanceTo(infected);
              if (dist < quarantine && dist > 0) {
                const repelStrength = (quarantine - dist) / quarantine;
                const angle = Math.atan2(this.y - infected.y, this.x - infected.x);
                this.vx += Math.cos(angle) * this.speed * repelStrength * 0.3;
                this.vy += Math.sin(angle) * this.speed * repelStrength * 0.3;
              }
            }
          }
        }
        
        // Normalize velocity to current speed AFTER all forces ‚Äî this caps it
        const mag = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
        if (mag > 0) {
          this.vx = (this.vx / mag) * this.speed;
          this.vy = (this.vy / mag) * this.speed;
        }
        
        this.x += this.vx;
        this.y += this.vy;
      }
      
      isActivelySick(person) {
        return person.state === 'infected' && person.sickTimer <= person.activeInfectionFrames;
      }
      
      tryInfect(people, infectionDist, infectionRate, currentVariant, virusParticles, vaccineEffectiveness) {
        if (this.state !== 'infected') return;
        
        let actualRate = infectionRate;
        let actualDist = infectionDist;
        
        // Use variant's absolute values if this person has the mutant
        if (this.variant === 'mutant' && currentVariant) {
          actualRate = currentVariant.infectionRate;
          actualDist = currentVariant.infectionDist;
        }
        
        if (this.isSuperSpreader) {
          actualRate *= 5;
        }
        
        for (const person of people) {
          // Target both normal AND vaccinated people
          if ((person.state === 'normal' || person.state === 'vaccinated') && this.distanceTo(person) <= actualDist) {
            if (Math.random() <= actualRate) {
              // Vaccinated people resist based on vaccine effectiveness
              if (person.state === 'vaccinated') {
                if (Math.random() < vaccineEffectiveness) continue; // vaccine blocked it
              }
              person.state = 'infected';
              person.variant = this.variant;
              
              // Set timers based on variant or base values
              if (this.variant === 'mutant' && currentVariant) {
                person.incubationFrames = Math.floor(currentVariant.incubationDays * 60);
                person.activeInfectionFrames = Math.floor(currentVariant.infectiousDays * 60);
                person.totalSickFrames = person.incubationFrames + person.activeInfectionFrames;
                person.sickTimer = person.totalSickFrames;
              } else {
                person.sickTimer = person.totalSickFrames;
              }
              
              virusParticles.push(new VirusParticle(this.x, this.y, person.x, person.y));
            }
          }
        }
      }
      
      updateDisease(survivalRate, hospitalStrained, immunityDuration, vaccineEffectiveness, tickDisease, currentVariant) {
        if (!tickDisease) return; // timers only tick once per rAF
        
        if (this.state === 'vaccinated' && immunityDuration > 0) {
          this.immunityTimer++;
          const immunityFrames = immunityDuration * 7 * 60;
          if (this.immunityTimer > immunityFrames) {
            this.state = 'normal';
          }
        }
        
        if (this.state === 'recovered' && immunityDuration > 0) {
          this.immunityTimer++;
          const immunityFrames = immunityDuration * 7 * 60;
          if (this.immunityTimer > immunityFrames) {
            this.state = 'normal';
          }
        }
        
        if (this.state !== 'infected') return;
        
        this.infectTimer = (this.infectTimer + 1) % 60;
        this.sickTimer--;
        
        if (this.sickTimer <= 0) {
          let actualSurvival = survivalRate;
          
          if (hospitalStrained) {
            actualSurvival *= 0.75;
          }
          
          // Use variant's absolute survival if mutant
          if (this.variant === 'mutant' && currentVariant) {
            actualSurvival = currentVariant.survivalRate;
            if (hospitalStrained) {
              actualSurvival *= 0.75;
            }
          }
          
          this.state = Math.random() <= actualSurvival ? 'recovered' : 'dead';
          this.immunityTimer = 0;
        }
      }
      
      distanceTo(other) {
        const dx = this.x - other.x;
        const dy = this.y - other.y;
        return Math.sqrt(dx * dx + dy * dy);
      }
      
      getVisualState() {
        if (this.state !== 'infected') return this.state;
        return this.sickTimer <= this.activeInfectionFrames ? 'sick' : 'carrier';
      }
    }

    function VirusSim() {
      const [simState, setSimState] = React.useState('welcome');
      const [paused, setPaused] = React.useState(true);
      const [showInstructions, setShowInstructions] = React.useState(false);
      const [activeTab, setActiveTab] = React.useState('properties');
      const [isSpeedingUp, setIsSpeedingUp] = React.useState(false);
      const [menuCollapsed, setMenuCollapsed] = React.useState(false);
      
      const [population, setPopulation] = React.useState(130);
      const [incubationDays, setIncubationDays] = React.useState(7);
      const [infectionDays, setInfectionDays] = React.useState(7);
      const [vaccinationRate, setVaccinationRate] = React.useState(0);
      const [infectionRate, setInfectionRate] = React.useState(0.50);
      const [infectionDist, setInfectionDist] = React.useState(50);
      const [survivalRate, setSurvivalRate] = React.useState(0.50);
      const [quarantineDist, setQuarantineDist] = React.useState(25);
      
      const [mobilityLevel, setMobilityLevel] = React.useState(0.5);
      const [hospitalCapacity, setHospitalCapacity] = React.useState(0.15);
      const [mutationEnabled, setMutationEnabled] = React.useState(false);
      const [mutationRate, setMutationRate] = React.useState(0);
      const [vaccineEffectiveness, setVaccineEffectiveness] = React.useState(0.50);
      const [immunityDuration, setImmunityDuration] = React.useState(1);
      
      const [people, setPeople] = React.useState([]);
      const [virusParticles, setVirusParticles] = React.useState([]);
      const [trackData, setTrackData] = React.useState({
        normal: [],
        carrier: [],
        sick: [],
        vaccinated: [],
        recovered: [],
        dead: []
      });
      const [analysisData, setAnalysisData] = React.useState(null);
      const [hospitalStrained, setHospitalStrained] = React.useState(false);
      const [superSpreaderActive, setSuperSpreaderActive] = React.useState(false);
      const [currentVariant, setCurrentVariant] = React.useState(null);
      const [dayCounter, setDayCounter] = React.useState(0);
      
      const canvasRef = React.useRef(null);
      const frameCountRef = React.useRef(0);
      const animationRef = React.useRef(null);
      const peopleRef = React.useRef([]);
      const virusParticlesRef = React.useRef([]);
      
      // Refs so the animation loop always reads current slider values
      // without needing them in the dependency array
      const infectionDistRef = React.useRef(infectionDist);
      const infectionRateRef = React.useRef(infectionRate);
      const survivalRateRef = React.useRef(survivalRate);
      const quarantineDistRef = React.useRef(quarantineDist);
      const mobilityLevelRef = React.useRef(mobilityLevel);
      const hospitalCapacityRef = React.useRef(hospitalCapacity);
      const mutationEnabledRef = React.useRef(mutationEnabled);
      const mutationRateRef = React.useRef(mutationRate);
      const vaccineEffectivenessRef = React.useRef(vaccineEffectiveness);
      const immunityDurationRef = React.useRef(immunityDuration);
      const isSpeedingUpRef = React.useRef(isSpeedingUp);
      const pausedRef = React.useRef(paused);
      const hospitalStrainedRef = React.useRef(false);
      const currentVariantRef = React.useRef(currentVariant);
      const populationRef = React.useRef(population);
      
      // Keep all refs in sync with state
      React.useEffect(() => { infectionDistRef.current = infectionDist; }, [infectionDist]);
      React.useEffect(() => { infectionRateRef.current = infectionRate; }, [infectionRate]);
      React.useEffect(() => { survivalRateRef.current = survivalRate; }, [survivalRate]);
      React.useEffect(() => { quarantineDistRef.current = quarantineDist; }, [quarantineDist]);
      React.useEffect(() => { mobilityLevelRef.current = mobilityLevel; }, [mobilityLevel]);
      React.useEffect(() => { hospitalCapacityRef.current = hospitalCapacity; }, [hospitalCapacity]);
      React.useEffect(() => { mutationEnabledRef.current = mutationEnabled; }, [mutationEnabled]);
      React.useEffect(() => { mutationRateRef.current = mutationRate; }, [mutationRate]);
      React.useEffect(() => { vaccineEffectivenessRef.current = vaccineEffectiveness; }, [vaccineEffectiveness]);
      React.useEffect(() => { immunityDurationRef.current = immunityDuration; }, [immunityDuration]);
      React.useEffect(() => { isSpeedingUpRef.current = isSpeedingUp; }, [isSpeedingUp]);
      React.useEffect(() => { pausedRef.current = paused; }, [paused]);
      React.useEffect(() => { currentVariantRef.current = currentVariant; }, [currentVariant]);
      React.useEffect(() => { populationRef.current = population; }, [population]);
      
      const applyPreset = (presetKey) => {
        const p = CONFIG.PRESETS[presetKey];
        setIncubationDays(p.incubation);
        setInfectionDays(p.infectionTime);
        setInfectionRate(p.infectionRate);
        setInfectionDist(p.infectionDist);
        setSurvivalRate(p.survival);
      };
      
      const startSimulation = () => {
        const newPeople = [];
        const simWidth = CONFIG.SIM_AREA_WIDTH;
        const simHeight = CONFIG.CANVAS_HEIGHT;
        
        for (let i = 0; i < population; i++) {
          const x = Math.random() * (simWidth - 40) + 20;
          const y = Math.random() * (simHeight - 40) + 20;
          newPeople.push(new Person(x, y, 'normal', incubationDays, infectionDays));
        }
        
        const vacCount = Math.floor(population * vaccinationRate);
        for (let i = 0; i < vacCount; i++) {
          newPeople[i].state = 'vaccinated';
        }
        
        if (newPeople.length > 0) {
          newPeople[0].state = 'infected';
        }
        
        peopleRef.current = newPeople;
        virusParticlesRef.current = [];
        setPeople(newPeople);
        setVirusParticles([]);
        setTrackData({ normal: [], carrier: [], sick: [], vaccinated: [], recovered: [], dead: [] });
        frameCountRef.current = 0;
        setDayCounter(0);
        setSimState('sim');
        setPaused(false);
      };
      
      const triggerSuperSpreaderEvent = () => {
        const centerX = Math.random() * (CONFIG.SIM_AREA_WIDTH * 0.6) + CONFIG.SIM_AREA_WIDTH * 0.2;
        const centerY = Math.random() * (CONFIG.CANVAS_HEIGHT * 0.6) + CONFIG.CANVAS_HEIGHT * 0.2;
        const eventRadius = 100;
        
        peopleRef.current.forEach(person => {
          const dist = Math.sqrt((person.x - centerX) ** 2 + (person.y - centerY) ** 2);
          if (dist > eventRadius && person.state === 'normal') {
            const angle = Math.atan2(centerY - person.y, centerX - person.x);
            const targetDist = eventRadius - 20;
            person.x = centerX - Math.cos(angle) * targetDist;
            person.y = centerY - Math.sin(angle) * targetDist;
          }
          if (dist < eventRadius && person.state === 'normal' && Math.random() < 0.6) {
            person.state = 'infected';
            person.sickTimer = person.totalSickFrames;
          }
        });
        
        setSuperSpreaderActive(true);
        setTimeout(() => setSuperSpreaderActive(false), 3000);
      };
      
      const infectOnePerson = () => {
        const normalPerson = peopleRef.current.find(p => p.state === 'normal');
        if (normalPerson) {
          normalPerson.state = 'infected';
          normalPerson.sickTimer = normalPerson.totalSickFrames;
        }
      };
      
      const resetSimulation = () => {
        startSimulation();
      };
      
      const goHome = () => {
        setSimState('welcome');
        setPaused(true);
        peopleRef.current = [];
        virusParticlesRef.current = [];
        setPeople([]);
        setVirusParticles([]);
        setTrackData({ normal: [], carrier: [], sick: [], vaccinated: [], recovered: [], dead: [] });
        setAnalysisData(null);
        setHospitalStrained(false);
        setDayCounter(0);
      };
      
      const goToAnalysis = () => {
        const total = trackData.normal.length;
        const lerp = (start, end, t) => start + (end - start) * t;
        const generatePoints = (data) => data.map((value, i) => ({
          x: lerp(100, CONFIG.CANVAS_WIDTH - 100, i / Math.max(1, total - 1)),
          y: lerp(CONFIG.CANVAS_HEIGHT - 150, 100, value / population)
        }));
        
        setAnalysisData({
          totalDays: total,
          normPoints: generatePoints(trackData.normal),
          carrierPoints: generatePoints(trackData.carrier),
          sickPoints: generatePoints(trackData.sick),
          vaccinatedPoints: generatePoints(trackData.vaccinated),
          recoverPoints: generatePoints(trackData.recovered),
          deadPoints: generatePoints(trackData.dead)
        });
        setSimState('analysis');
      };
      
      React.useEffect(() => {
        const handleKeyPress = (e) => {
          if (e.code === 'Space' && simState === 'welcome') {
            e.preventDefault();
            setSimState('start');
          }
          if (e.code === 'KeyP' && simState === 'sim') {
            setPaused(p => !p);
          }
          if (e.code === 'Space' && simState === 'sim' && 
              trackData.carrier.length > 0 && trackData.sick.length > 0 &&
              trackData.carrier[trackData.carrier.length - 1] === 0 &&
              trackData.sick[trackData.sick.length - 1] === 0) {
            e.preventDefault();
            goToAnalysis();
          }
        };
        
        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, [simState, trackData]);
      
      React.useEffect(() => {
        if (simState !== 'sim' || !canvasRef.current) return;
        
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        
        const getStateColor = (state) => {
          const colors = {
            normal: '#FFFFFF',
            carrier: '#FFA500',
            sick: '#00FF00',
            vaccinated: '#9370DB',
            recovered: '#00FFFF',
            dead: '#8B0000'
          };
          return colors[state] || '#FFFFFF';
        };
        
        const animate = () => {
          ctx.fillStyle = '#2a2a2a';
          ctx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
          
          const people = peopleRef.current;
          const virusParticles = virusParticlesRef.current;
          
          if (!pausedRef.current && people.length > 0) {
            const updatesPerFrame = isSpeedingUpRef.current ? CONFIG.SPEED_MULTIPLIER : 1;
            
            for (let update = 0; update < updatesPerFrame; update++) {
              const infected = people.filter(p => p.state === 'infected');
              
              const activelySick = infected.filter(p => 
                p.sickTimer <= p.activeInfectionFrames
              ).length;
              const capacity = Math.floor(populationRef.current * hospitalCapacityRef.current);
              hospitalStrainedRef.current = (activelySick > capacity);
              
              // Only tick disease timers on the LAST iteration so they run once per rAF
              const tickDisease = (update === updatesPerFrame - 1);
              
              people.forEach(person => {
                person.move(quarantineDistRef.current, infected, CONFIG.SIM_AREA_WIDTH, CONFIG.CANVAS_HEIGHT, mobilityLevelRef.current);
                
                if (person.infectTimer === 0) {
                  person.tryInfect(people, infectionDistRef.current, infectionRateRef.current, currentVariantRef.current, virusParticles, vaccineEffectivenessRef.current);
                }
                
                person.updateDisease(survivalRateRef.current, hospitalStrainedRef.current, immunityDurationRef.current, vaccineEffectivenessRef.current, tickDisease, currentVariantRef.current);
              });
              
              if (mutationEnabledRef.current && Math.random() < mutationRateRef.current && infected.length > 0) {
                const infectedPerson = infected[Math.floor(Math.random() * infected.length)];
                if (infectedPerson && infectedPerson.variant === 'original') {
                  // Generate random variant with absolute values in slider ranges
                  const newVariant = {
                    incubationDays: 0.5 + Math.random() * 14.5,      // 0.5-15 days
                    infectiousDays: 1 + Math.random() * 14,          // 1-15 days
                    infectionRate: 0.01 + Math.random() * 0.99,      // 1%-100%
                    infectionDist: 1 + Math.random() * 9,            // 1-10 meters
                    survivalRate: 0.01 + Math.random() * 0.99        // 1%-100%
                  };
                  setCurrentVariant(newVariant);
                  infectedPerson.variant = 'mutant';
                }
              }
            }

            // Day counter: ticks once every 60 rAF calls (= 1 second at 60fps = 1 day)
            frameCountRef.current++;
            if (frameCountRef.current >= 60) {
              frameCountRef.current = 0;

              const counts = { normal: 0, carrier: 0, sick: 0, vaccinated: 0, recovered: 0, dead: 0 };
              people.forEach(p => {
                if (p.state === 'infected') {
                  if (p.sickTimer <= p.activeInfectionFrames) {
                    counts.sick++;
                  } else {
                    counts.carrier++;
                  }
                } else {
                  counts[p.state]++;
                }
              });
              
              setTrackData(prev => ({
                normal: [...prev.normal, counts.normal],
                carrier: [...prev.carrier, counts.carrier],
                sick: [...prev.sick, counts.sick],
                vaccinated: [...prev.vaccinated, counts.vaccinated],
                recovered: [...prev.recovered, counts.recovered],
                dead: [...prev.dead, counts.dead]
              }));
              
              setHospitalStrained(hospitalStrainedRef.current);
              setDayCounter(d => d + 1);
            }
          }
          
          // Update virus particles in the ref directly
          virusParticlesRef.current = virusParticles.filter(p => p.alive);
          virusParticlesRef.current.forEach(p => p.update());
          virusParticlesRef.current.forEach(particle => {
            if (particle.alive) particle.draw(ctx);
          });
          
          // Draw people
          people.forEach(person => {
            const visualState = person.getVisualState();
            ctx.fillStyle = getStateColor(visualState);
            ctx.beginPath();
            ctx.arc(person.x, person.y, person.radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            if (person.state === 'infected' && person.variant !== 'original') {
              ctx.strokeStyle = '#FF0000';
              ctx.lineWidth = 2;
              ctx.beginPath();
              ctx.arc(person.x, person.y, person.radius + 3, 0, Math.PI * 2);
              ctx.stroke();
            }
          });
          
          animationRef.current = requestAnimationFrame(animate);
        };
        
        animate();
        
        return () => {
          if (animationRef.current) {
            cancelAnimationFrame(animationRef.current);
          }
        };
      }, [simState]);
      
      return (
        <div style={{ 
          width: '100vw', 
          height: '100vh', 
          display: 'flex', 
          justifyContent: 'center', 
          alignItems: 'center',
          backgroundColor: '#1a1a1a'
        }}>
          <div style={{ position: 'relative', width: '100%', height: '100%' }}>
            <canvas 
              ref={canvasRef}
              width={CONFIG.CANVAS_WIDTH}
              height={CONFIG.CANVAS_HEIGHT}
            />
            
            
            {simState === 'sim' && (
              <div style={{
                position: 'absolute',
                bottom: 0,
                left: 0,
                width: '100%',
                display: 'flex',
                justifyContent: 'center',
                gap: '28px',
                padding: '10px 0',
                background: 'rgba(0,0,0,0.45)',
                zIndex: 5,
                flexWrap: 'wrap'
              }}>
                {[
                  { color: '#FFFFFF', label: 'Healthy' },
                  { color: '#FFA500', label: 'Incubation' },
                  { color: '#00FF00', label: 'Infectious' },
                  { color: '#9370DB', label: 'Vaccinated' },
                  { color: '#00FFFF', label: 'Recovered' },
                  { color: '#8B0000', label: 'Dead' }
                ].map(item => (
                  <div key={item.label} style={{ display: 'flex', alignItems: 'center', gap: '7px' }}>
                    <div style={{ width: '14px', height: '14px', borderRadius: '50%', backgroundColor: item.color }} />
                    <span style={{ color: '#ccc', fontSize: '13px' }}>{item.label}</span>
                  </div>
                ))}
              </div>
            )}
            {hospitalStrained && simState === 'sim' && (
              <div className="alert-banner">
                HOSPITALS OVERWHELMED - Death Rate Increased
              </div>
            )}
            
            {superSpreaderActive && simState === 'sim' && (
              <div className="superspreader-alert">
                LARGE GATHERING - Super-Spreader Event!
              </div>
            )}
            
            {simState === 'welcome' && (
              <WelcomeScreen 
                onContinue={() => setSimState('start')}
              />
            )}
            
            {simState === 'start' && (
              <StartScreen 
                population={population}
                setPopulation={setPopulation}
                vaccinationRate={vaccinationRate}
                setVaccinationRate={setVaccinationRate}
                startSimulation={startSimulation}
              />
            )}
            
            {simState === 'sim' && (
              <SimControls 
                paused={paused}
                setPaused={setPaused}
                infectOnePerson={infectOnePerson}
                resetSimulation={resetSimulation}
                goHome={goHome}
                activeTab={activeTab}
                setActiveTab={setActiveTab}
                incubationDays={incubationDays}
                setIncubationDays={setIncubationDays}
                infectionDays={infectionDays}
                setInfectionDays={setInfectionDays}
                infectionRate={infectionRate}
                setInfectionRate={setInfectionRate}
                infectionDist={infectionDist}
                setInfectionDist={setInfectionDist}
                survivalRate={survivalRate}
                setSurvivalRate={setSurvivalRate}
                quarantineDist={quarantineDist}
                setQuarantineDist={setQuarantineDist}
                mobilityLevel={mobilityLevel}
                setMobilityLevel={setMobilityLevel}
                hospitalCapacity={hospitalCapacity}
                setHospitalCapacity={setHospitalCapacity}
                mutationEnabled={mutationEnabled}
                setMutationEnabled={setMutationEnabled}
                mutationRate={mutationRate}
                setMutationRate={setMutationRate}
                vaccineEffectiveness={vaccineEffectiveness}
                setVaccineEffectiveness={setVaccineEffectiveness}
                immunityDuration={immunityDuration}
                setImmunityDuration={setImmunityDuration}
                triggerSuperSpreaderEvent={triggerSuperSpreaderEvent}
                currentVariant={currentVariant}
                applyPreset={applyPreset}
                trackData={trackData}
                goToAnalysis={goToAnalysis}
                isSpeedingUp={isSpeedingUp}
                setIsSpeedingUp={setIsSpeedingUp}
                dayCounter={dayCounter}
                menuCollapsed={menuCollapsed}
                setMenuCollapsed={setMenuCollapsed}
              />
            )}
            
            {simState === 'analysis' && analysisData && (
              <AnalysisScreen 
                data={analysisData}
                trackData={trackData}
                population={population}
                goHome={goHome}
              />
            )}
          </div>
        </div>
      );
    }

    function SliderControl({ label, value, rawValue, onChange, min, max, step = 1 }) {
      // rawValue is the actual number for the <input>; value is the display string
      const inputVal = (rawValue !== undefined && rawValue !== null) ? rawValue : (typeof value === 'string' ? parseFloat(value) : value);
      return (
        <div style={{ marginBottom: '20px' }}>
          <label className="slider-label">
            {label}: <span className="slider-value">{value}</span>
          </label>
          <input 
            type="range"
            min={min}
            max={max}
            step={step}
            value={inputVal}
            onChange={(e) => onChange(parseFloat(e.target.value))}
          />
        </div>
      );
    }

    function WelcomeScreen({ onContinue }) {
      return (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          color: 'white',
          padding: '40px',
          overflowY: 'auto',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center'
        }}>
          <h1 style={{ 
            textAlign: 'center', 
            fontSize: '56px', 
            marginBottom: '30px',
            textShadow: '0 4px 20px rgba(0,0,0,0.3)',
            fontWeight: '800'
          }}>
            Welcome to the ViralX Simulation
          </h1>
          
          <div className="welcome-panel">
            <h2 style={{ color: '#667eea', marginBottom: '20px', fontSize: '28px' }}>
              How to Use This Simulation
            </h2>
            
            <p style={{ lineHeight: '1.8', marginBottom: '20px' }}>
              ViralX is an epidemic simulation that shows how outbreaks move through a population. By adjusting key variables, you can observe how infections grow, slow down, or disappear as conditions change in real time.
            </p>
            
            <p style={{ lineHeight: '1.8', marginBottom: '20px' }}>
              You can load known diseases or create custom ones, then watch how different strategies influence the outcome. The simulation guides you naturally through the steps.
            </p>

            <h3 style={{ color: '#667eea', marginTop: '30px', marginBottom: '15px', fontSize: '22px' }}>
              Control Variables
            </h3>

            <div style={{ lineHeight: '2', marginBottom: '20px' }}>
              <strong>Basic Disease Properties:</strong>
              <ul style={{ marginLeft: '20px', marginTop: '10px' }}>
                <li><strong>Incubation Period</strong> - Time between exposure and symptom onset</li>
                <li><strong>Infectious Period</strong> - How long an infected person can spread the disease</li>
                <li><strong>Infection Rate (R‚ÇÄ)</strong> - Likelihood of transmission per contact</li>
                <li><strong>Infection Distance</strong> - Maximum range of spread in meters</li>
                <li><strong>Survival Rate</strong> - Chance of recovery versus death</li>
                <li><strong>Quarantine Barrier</strong> - Distance maintained from infected individuals</li>
              </ul>
            </div>

            <div style={{ lineHeight: '2', marginBottom: '20px' }}>
              <strong>Advanced Strategic Controls:</strong>
              <ul style={{ marginLeft: '20px', marginTop: '10px' }}>
                <li><strong>Mutations</strong> - New variants with altered characteristics</li>
                <li><strong>Super-Spreader Events</strong> - Large outbreaks caused by mass gatherings</li>
                <li><strong>Hospital Capacity</strong> - Limits of the healthcare system</li>
                <li><strong>Vaccine Effectiveness</strong> - Level of protection provided by vaccination</li>
                <li><strong>Immunity Duration</strong> - Length of post-infection or vaccine protection (weeks)</li>
                <li><strong>Mobility Patterns</strong> - How actively the population moves</li>
              </ul>
            </div>

            <h3 style={{ color: '#667eea', marginTop: '30px', marginBottom: '15px', fontSize: '22px' }}>
              What You Can Learn
            </h3>
            
            <p style={{ lineHeight: '1.8', marginBottom: '20px' }}>
              ViralX helps illustrate how outbreaks behave under different conditions. It allows you to explore disease dynamics, compare intervention strategies, and see how small changes can dramatically alter results. By experimenting with variables, you can observe how infections spread, peak, decline, or resurface‚Äîand how effective measures can flatten the curve.
            </p>
            
            <button 
              onClick={onContinue}
              style={{ 
                width: '100%', 
                padding: '20px',
                fontSize: '20px',
                marginTop: '20px'
              }}
              className="success"
            >
              Continue
            </button>
          </div>
        </div>
      );
    }

    function StartScreen({ 
      population, setPopulation, 
      vaccinationRate, setVaccinationRate,
      startSimulation
    }) {
      return (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          color: 'white',
          padding: '40px',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center'
        }}>
          <div className="control-panel" style={{ width: '500px' }}>
            <h2 style={{ marginBottom: '20px', fontSize: '24px', textAlign: 'center' }}>
              Initial Parameters
            </h2>
            
            <SliderControl 
              label="Population"
              value={population}
              rawValue={population}
              onChange={setPopulation}
              min={10}
              max={250}
            />
            <SliderControl 
              label="Vaccination Rate"
              value={(vaccinationRate * 100).toFixed(0) + '%'}
              rawValue={vaccinationRate * 100}
              onChange={(v) => setVaccinationRate(v / 100)}
              min={0}
              max={100}
            />
            
            <button 
              onClick={startSimulation}
              style={{ width: '100%', padding: '20px', fontSize: '20px', marginTop: '30px' }}
              className="success"
            >
              Start Simulation
            </button>
          </div>
        </div>
      );
    }

    function SimControls({ 
      paused, setPaused, 
      infectOnePerson, resetSimulation, goHome,
      activeTab, setActiveTab,
      incubationDays, setIncubationDays,
      infectionDays, setInfectionDays,
      infectionRate, setInfectionRate,
      infectionDist, setInfectionDist,
      survivalRate, setSurvivalRate,
      quarantineDist, setQuarantineDist,
      mobilityLevel, setMobilityLevel,
      hospitalCapacity, setHospitalCapacity,
      mutationEnabled, setMutationEnabled,
      mutationRate, setMutationRate,
      vaccineEffectiveness, setVaccineEffectiveness,
      immunityDuration, setImmunityDuration,
      triggerSuperSpreaderEvent,
      currentVariant,
      applyPreset,
      trackData, goToAnalysis,
      isSpeedingUp, setIsSpeedingUp,
      dayCounter,
      menuCollapsed, setMenuCollapsed
    }) {
      const hasInfected = trackData.carrier.length > 0 && trackData.sick.length > 0;
      const outbreakEnded = hasInfected && 
        trackData.carrier[trackData.carrier.length - 1] === 0 &&
        trackData.sick[trackData.sick.length - 1] === 0;
      const [showVariantInfo, setShowVariantInfo] = React.useState(false);
      
      return (
        <>
          <button 
            className="toggle-button"
            onClick={() => setMenuCollapsed(!menuCollapsed)}
          >
            {menuCollapsed ? '‚óÄ' : '‚ñ∂'}
          </button>
          
          <div className={`control-panel ${menuCollapsed ? 'collapsed' : ''}`} style={{
            position: 'absolute',
            right: '20px',
            top: '20px',
            minWidth: '380px',
            maxHeight: '90vh',
            overflowY: 'auto'
          }}>
          
          <h2 style={{ marginBottom: '15px', color: 'white', fontSize: '22px' }}>
            Control Panel - Day {dayCounter}
          </h2>
          
          <button onClick={goHome} className="danger" style={{ width: '100%', marginBottom: '10px' }}>
            üè† Home
          </button>
          
          <button onClick={() => setPaused(!paused)} style={{ width: '100%' }}>
            {paused ? '‚ñ∂Ô∏è Start' : '‚è∏Ô∏è Pause'}
          </button>
          
          <button 
            className="speed-control"
            onMouseDown={() => setIsSpeedingUp(true)}
            onMouseUp={() => setIsSpeedingUp(false)}
            onMouseLeave={() => setIsSpeedingUp(false)}
            onTouchStart={() => setIsSpeedingUp(true)}
            onTouchEnd={() => setIsSpeedingUp(false)}
            style={{ width: '100%', marginTop: '10px' }}
          >
            {isSpeedingUp ? '‚ö° 4X SPEED' : '‚ö° HOLD TO SPEED UP'}
          </button>
          
          <button onClick={infectOnePerson} className="secondary" style={{ width: '100%', marginTop: '10px' }}>
            üíâ Infect One
          </button>
          <button onClick={resetSimulation} className="danger" style={{ width: '100%' }}>
            üîÑ Reset
          </button>
          <button onClick={goToAnalysis} className="success" style={{ width: '100%', marginTop: '8px' }}>
            üìä View Analysis
          </button>
          
          <div style={{ marginTop: '20px' }}>
            <div style={{ display: 'flex', gap: '5px', marginBottom: '15px', flexWrap: 'wrap' }}>
              <button 
                className={`tab ${activeTab === 'properties' ? 'active' : ''}`}
                onClick={() => setActiveTab('properties')}
                style={{ flex: '1 0 45%' }}
              >
                Properties
              </button>
              <button 
                className={`tab ${activeTab === 'viruses' ? 'active' : ''}`}
                onClick={() => setActiveTab('viruses')}
                style={{ flex: '1 0 45%' }}
              >
                Viruses
              </button>
              <button 
                className={`tab ${activeTab === 'advanced' ? 'active' : ''}`}
                onClick={() => setActiveTab('advanced')}
                style={{ flex: '1 0 45%' }}
              >
                Advanced
              </button>
            </div>
            
            {activeTab === 'properties' && (
              <div className="tab-content">
                <SliderControl 
                  label="Incubation Period"
                  value={incubationDays.toFixed(1) + ' days'}
                  rawValue={incubationDays}
                  onChange={setIncubationDays}
                  min={0.5}
                  max={15}
                  step={0.5}
                />
                <SliderControl 
                  label="Infectious Period"
                  value={infectionDays.toFixed(1) + ' days'}
                  rawValue={infectionDays}
                  onChange={setInfectionDays}
                  min={1}
                  max={15}
                  step={0.5}
                />
                <SliderControl 
                  label="Infection Rate (R‚ÇÄ)"
                  value={(infectionRate * 100).toFixed(0) + '%'}
                  rawValue={infectionRate * 100}
                  onChange={(v) => setInfectionRate(v / 100)}
                  min={1}
                  max={100}
                />
                <SliderControl 
                  label="Infection Distance"
                  value={(infectionDist / 10).toFixed(1) + ' meters'}
                  rawValue={infectionDist}
                  onChange={setInfectionDist}
                  min={10}
                  max={100}
                />
                <SliderControl 
                  label="Survival Rate"
                  value={(survivalRate * 100).toFixed(1) + '%'}
                  rawValue={survivalRate * 100}
                  onChange={(v) => setSurvivalRate(v / 100)}
                  min={1}
                  max={100}
                  step={0.1}
                />
                <SliderControl 
                  label="Quarantine Barrier"
                  value={quarantineDist.toFixed(0)}
                  onChange={setQuarantineDist}
                  min={0}
                  max={50}
                />
              </div>
            )}
            
            {activeTab === 'viruses' && (
              <div className="tab-content">
                <h3 style={{ color: 'white', marginBottom: '15px', fontSize: '18px' }}>
                  Disease Presets
                </h3>
                <div className="preset-grid">
                  <button onClick={() => { applyPreset('COVID'); setActiveTab('properties'); }}>COVID-19</button>
                  <button onClick={() => { applyPreset('TB'); setActiveTab('properties'); }}>Tuberculosis</button>
                  <button onClick={() => { applyPreset('RHINO'); setActiveTab('properties'); }}>Rhinovirus</button>
                  <button onClick={() => { applyPreset('MEASLES'); setActiveTab('properties'); }}>Measles</button>
                  <button onClick={() => { applyPreset('INFLUENZA'); setActiveTab('properties'); }}>Influenza</button>
                  <button onClick={() => { applyPreset('EBOLA'); setActiveTab('properties'); }}>Ebola</button>
                </div>
              </div>
            )}
            
            {activeTab === 'advanced' && (
              <div className="tab-content">
                <div style={{ marginBottom: '15px' }}>
                  <label className="slider-label">
                    <input 
                      type="checkbox"
                      checked={mutationEnabled}
                      onChange={(e) => {
                        setMutationEnabled(e.target.checked);
                        if (e.target.checked) setMutationRate(0.01);
                        else setMutationRate(0);
                      }}
                      style={{ marginRight: '10px' }}
                    />
                    Enable Mutations (red ring = variant)
                  </label>
                </div>
                {mutationEnabled && (
                  <SliderControl 
                    label="Mutation Rate"
                    value={(mutationRate * 100).toFixed(2) + '%'}
                    rawValue={mutationRate * 100}
                    onChange={(v) => setMutationRate(v / 100)}
                    min={0}
                    max={2}
                    step={0.01}
                  />
                )}

                {mutationEnabled && currentVariant && (
                  <div style={{ marginBottom: '15px' }}>
                    <button 
                      className="secondary"
                      style={{ width: '100%', padding: '8px', fontSize: '13px' }}
                      onClick={() => setShowVariantInfo(!showVariantInfo)}
                    >
                      üß¨ {showVariantInfo ? 'Hide' : 'Show'} Mutant Properties
                    </button>
                    {showVariantInfo && (
                      <div style={{ 
                        background: 'rgba(255,0,0,0.15)', 
                        border: '1px solid rgba(255,0,0,0.4)',
                        borderRadius: '8px', 
                        padding: '12px', 
                        marginTop: '8px',
                        fontSize: '13px',
                        lineHeight: '1.9',
                        color: '#ffcccc'
                      }}>
                        Incubation Period: {currentVariant.incubationDays.toFixed(1)} days<br/>
                        Infectious Period: {currentVariant.infectiousDays.toFixed(1)} days<br/>
                        Infection Rate: {(currentVariant.infectionRate * 100).toFixed(0)}%<br/>
                        Infection Distance: {currentVariant.infectionDist.toFixed(1)} meters<br/>
                        Survival Rate: {(currentVariant.survivalRate * 100).toFixed(1)}%
                      </div>
                    )}
                  </div>
                )}
                
                
                <button 
                  onClick={triggerSuperSpreaderEvent}
                  className="secondary"
                  style={{ width: '100%', marginBottom: '20px' }}
                >
                  Trigger Super-Spreader Event
                </button>
                
                <SliderControl 
                  label="Hospital Capacity"
                  value={(hospitalCapacity * 100).toFixed(0) + '% of population'}
                  rawValue={hospitalCapacity * 100}
                  onChange={(v) => setHospitalCapacity(v / 100)}
                  min={0}
                  max={30}
                />
                
                <SliderControl 
                  label="Vaccine Effectiveness"
                  value={(vaccineEffectiveness * 100).toFixed(0) + '%'}
                  rawValue={vaccineEffectiveness * 100}
                  onChange={(v) => setVaccineEffectiveness(v / 100)}
                  min={0}
                  max={100}
                />
                
                <SliderControl 
                  label="Immunity Duration"
                  value={immunityDuration.toFixed(0) + ' weeks'}
                  rawValue={immunityDuration}
                  onChange={setImmunityDuration}
                  min={1}
                  max={52}
                  step={1}
                />
                
                <SliderControl 
                  label="Mobility Patterns"
                  value={(mobilityLevel * 100).toFixed(0) + '%'}
                  rawValue={mobilityLevel * 100}
                  onChange={(v) => setMobilityLevel(v / 100)}
                  min={1}
                  max={100}
                  step={1}
                />
              </div>
            )}
          </div>
        </div>
        </>
      );
    }

    function AnalysisScreen({ data, trackData, population, goHome }) {
      const [timeSlider, setTimeSlider] = React.useState(0);
      const canvasRef = React.useRef(null);
      
      const sliderTime = Math.min(Math.floor(timeSlider), data.totalDays - 1);
      
      React.useEffect(() => {
        if (!canvasRef.current || !data) return;
        
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
        
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 10; i++) {
          const y = 100 + (CONFIG.CANVAS_HEIGHT - 250) * i / 10;
          ctx.beginPath();
          ctx.moveTo(100, y);
          ctx.lineTo(CONFIG.CANVAS_WIDTH - 100, y);
          ctx.stroke();
        }
        
        const drawSmoothLine = (points, color) => {
          if (points.length < 2) return;
          
          const gradient = ctx.createLinearGradient(0, CONFIG.CANVAS_HEIGHT - 150, 0, 100);
          gradient.addColorStop(0, color);
          gradient.addColorStop(1, color + '88');
          
          ctx.strokeStyle = gradient;
          ctx.lineWidth = 3;
          ctx.shadowBlur = 10;
          ctx.shadowColor = color;
          
          ctx.beginPath();
          ctx.moveTo(points[0].x, points[0].y);
          
          for (let i = 1; i < points.length - 2; i++) {
            const xc = (points[i].x + points[i + 1].x) / 2;
            const yc = (points[i].y + points[i + 1].y) / 2;
            ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
          }
          
          if (points.length > 2) {
            ctx.quadraticCurveTo(
              points[points.length - 2].x,
              points[points.length - 2].y,
              points[points.length - 1].x,
              points[points.length - 1].y
            );
          }
          
          ctx.stroke();
          ctx.shadowBlur = 0;
        };
        
        drawSmoothLine(data.normPoints, '#FFFFFF');
        drawSmoothLine(data.carrierPoints, '#FFA500');
        drawSmoothLine(data.sickPoints, '#00FF00');
        drawSmoothLine(data.vaccinatedPoints, '#9370DB');
        drawSmoothLine(data.recoverPoints, '#00FFFF');
        drawSmoothLine(data.deadPoints, '#FF0000');
        
        if (sliderTime < data.totalDays) {
          const xPos = 100 + (CONFIG.CANVAS_WIDTH - 200) * (sliderTime / Math.max(1, data.totalDays - 1));
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(xPos, 100);
          ctx.lineTo(xPos, CONFIG.CANVAS_HEIGHT - 150);
          ctx.stroke();
          ctx.setLineDash([]);
        }
        
        const centerX = CONFIG.CANVAS_WIDTH - 200;
        const centerY = CONFIG.CANVAS_HEIGHT / 2;
        const radius = 150;
        
        const total = trackData.normal[sliderTime] + trackData.carrier[sliderTime] + 
                     trackData.sick[sliderTime] + trackData.vaccinated[sliderTime] +
                     trackData.recovered[sliderTime] + trackData.dead[sliderTime];
        
        let currentAngle = -Math.PI / 2;
        
        const drawPieSegment = (value, color) => {
          if (value === 0) return;
          
          const sliceAngle = (value / total) * Math.PI * 2;
          
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
          ctx.closePath();
          ctx.fill();
          
          ctx.strokeStyle = '#2a2a2a';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          currentAngle += sliceAngle;
        };
        
        drawPieSegment(trackData.normal[sliderTime], '#FFFFFF');
        drawPieSegment(trackData.carrier[sliderTime], '#FFA500');
        drawPieSegment(trackData.sick[sliderTime], '#00FF00');
        drawPieSegment(trackData.vaccinated[sliderTime], '#9370DB');
        drawPieSegment(trackData.recovered[sliderTime], '#00FFFF');
        drawPieSegment(trackData.dead[sliderTime], '#8B0000');
        
      }, [data, sliderTime, trackData]);
      
      return (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          background: '#2a2a2a'
        }}>
          <canvas 
            ref={canvasRef}
            width={CONFIG.CANVAS_WIDTH}
            height={CONFIG.CANVAS_HEIGHT}
          />
          
          <div style={{ 
            position: 'absolute', 
            top: '30px', 
            left: '50%', 
            transform: 'translateX(-50%)',
            textAlign: 'center'
          }}>
            <h1 style={{ 
              fontSize: '48px',
              color: 'white',
              textShadow: '0 4px 20px rgba(0,0,0,0.5)',
              marginBottom: '10px'
            }}>
              Data Analysis
            </h1>
          </div>
          
          <div style={{ 
            position: 'absolute', 
            bottom: '40px', 
            left: '50%',
            transform: 'translateX(-50%)',
            width: '60%',
            background: 'rgba(0,0,0,0.7)',
            padding: '20px',
            borderRadius: '15px'
          }}>
            <label style={{ 
              color: 'white', 
              fontSize: '18px', 
              display: 'block',
              marginBottom: '15px',
              textAlign: 'center',
              fontWeight: '600'
            }}>
              Day {sliderTime} of {data.totalDays - 1}
            </label>
            <input 
              type="range"
              min={0}
              max={data.totalDays - 1}
              value={timeSlider}
              onChange={(e) => setTimeSlider(parseFloat(e.target.value))}
              style={{ width: '100%', height: '10px' }}
            />
          </div>
          
          <div style={{ 
            position: 'absolute', 
            top: '120px', 
            left: '50px',
            background: 'rgba(0,0,0,0.8)',
            padding: '25px',
            borderRadius: '15px',
            minWidth: '320px'
          }}>
            <h3 style={{ color: 'white', marginBottom: '15px', fontSize: '20px' }}>
              Statistics
            </h3>
            <div style={{ color: 'white', fontSize: '15px', lineHeight: '2' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span>Normal:</span>
                <strong>{trackData.normal[sliderTime]} ({Math.round(trackData.normal[sliderTime] / population * 100)}%)</strong>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span>Carrier:</span>
                <strong>{trackData.carrier[sliderTime]} ({Math.round(trackData.carrier[sliderTime] / population * 100)}%)</strong>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span>Sick:</span>
                <strong>{trackData.sick[sliderTime]} ({Math.round(trackData.sick[sliderTime] / population * 100)}%)</strong>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span>Vaccinated:</span>
                <strong>{trackData.vaccinated[sliderTime]} ({Math.round(trackData.vaccinated[sliderTime] / population * 100)}%)</strong>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span>Recovered:</span>
                <strong>{trackData.recovered[sliderTime]} ({Math.round(trackData.recovered[sliderTime] / population * 100)}%)</strong>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>Dead:</span>
                <strong>{trackData.dead[sliderTime]} ({Math.round(trackData.dead[sliderTime] / population * 100)}%)</strong>
              </div>
            </div>
          </div>
          
          <div style={{
            position: 'absolute',
            top: '30px',
            right: '30px'
          }}>
            <button 
              onClick={goHome}
              className="success"
              style={{ fontSize: '18px', padding: '15px 30px' }}
            >
              Try Again
            </button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VirusSim />);
  </script>
</body>
</html>
